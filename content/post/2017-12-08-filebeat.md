---
type: "post"
draft: true
author: "admin"
description: "description"
keywords: ["key", "words"]
topics: ["topic 1"]
tags: ["one", "two"]
---


# filebeat 笔记

**下载安装**

<https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html>


**配置输出elasticsearch**

	编辑filebeat.yml

	output.elasticsearch:
	  hosts: ["myEShost:9200"]
	  username: "elastic"
	  password: "elastic"
	setup.kibana:
	  host: "mykibanahost:5601"
	  username: "elastic" 
	  password: "elastic"

	https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-configuration.html

filebeat可以输出到elasticsearch或者logstash(还包括其他)。

如果要直接输出到elasticsearch需要在[elasticsearch上创建pipeline来切分字段](https://www.elastic.co/guide/en/beats/filebeat/current/configuring-ingest-node.html)或者使用logstash来切分字段


**Filebeat modules**

提供切分通用日志文件的模块，自带了以下几种模块

* Apache2 module  
* Auditd module  
* Icinga module
* MySQL module
* Nginx module
* Redis module
* System module

使用modules的先决条件

1. 安装ES
2. 安装完整的filebeat
3. 安装ES插件Ingest Node GeoIP，Inget User Agent 

	sudo bin/elasticsearch-plugin install ingest-geoip
	sudo bin/elasticsearch-plugin install ingest-user-agent

4. 确保es和kibana正在运行，能够正常接收数据

使用步骤
1. 配置并启动es和kibana
2. ./filebeat setup -e初始化设置环境

遇到问题

	CRIT Exiting: setup.template.name and setup.template.pattern have to be set if index name is modified.
	Exiting: setup.template.name and setup.template.pattern have to be set if index name is modified.

	如果设置了输出的esindex需要在filebeat中设置setup.template.name和setup.template.pattern

3. 选择需要启动的module

	./filebeat -e --modules system,nginx,mysql

4. 可以设置环境变量

	./filebeat -e --modules nginx -M "nginx.access.var.paths=[/var/log/nginx/access.log*]"

设置时区


	The configuration below enables the processor with the default settings.
	
	processors:
	- add_locale: ~
	This configuration enables the processor and configures it to add the time zone abbreviation to events.
	
	processors:
	- add_locale:
	    format: abbreviati
	
	<https://www.elastic.co/guide/en/beats/filebeat/master/add-locale.html>
	
配置apache日志

	https://medium.com/@oguzhan00/installing-filebeat-and-apache-access-log-analyzing-with-elasticsearch-278329bd9d34

使用模块

	显示所有
	./filebeat modules list

	开启nginx
	./filebeat modules enable nginx

	
	开启nginx
	./filebeat modules disable nginx

配置模块

<https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-nginx.html#configuring-nginx-module>

	modules.d/
	可以修改日志路径


	字段

	
**prospectors**
	
filebeat用来定位和处理文件的模块

**processors**

filebeat

<https://stackoverflow.com/questions/45163916/nginx-module-for-filebeats-doesnt-parse-access-logs>


**filebeat有坑**

  # Filebeat 默认支持 log rotation，但需要注意的是，Filebeat 不支持使用 NAS 或挂载磁盘保存日志的情况。因为在 Linux 系列的操作系统中，Filebeat 使用文件的 inode 信息判断当前文件是新文件还是旧文件。如果是 NAS 或挂载盘，同一个文件的 inode 信息会变化，导致 Filebeat 无法完整读取 log。
  # registry_file：这个文件记录了当前打开的所有 log 文件，以及每个文件的 inode、当前读取位置等信息。当 Filebeat 拿到一个 log 文件，首先查找 registry_file，如果是旧文件，就从记录的当前读取位置处开始读取；如果是新文件，则从开始位置读取；
  # close_older：如果某个日志文件经过 close_older 时间后没有修改操作，Filebeat 就关闭该文件的 handler。如果该值过长，则随着时间推移，Filebeat 打开的文件数量很多，耗费系统内存；
  # scan_frequency：Filebeat 每隔 scan_frequency 时间读取一次文件内容。对于关闭的文件，如果后续有更新，则经过 scan_frequency 时间后，Filebeat 将重新打开该文件，读取新增加的内容。
